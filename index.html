<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LCDR LIVE DATA</title>
<style>
body {
  background: url('https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-iriser-1366957.jpg') no-repeat center center fixed;
  background-size: cover;
  color:#fff;
  font-family: Arial, sans-serif;
}
body::before {
  content:"";
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  z-index:-1;
}
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px 10%;
  background-color: rgba(17,17,17,0.7);
}
.header h1 {
  margin:0;
  color:#008080;
  font-size:24px;
}
.date-info { color:#008080; font-size:24px; }

.table-container { width:80%; margin:24px auto; }

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü */
.table-header {
  background-color:#008080;
  color:#000;
  font-weight:bold;
  font-size:18px;
  padding:10px 16px;
  border-radius:10px 10px 0 0;
}

/* –ö–Ω–æ–ø–∫–∏ —Å–∫—Ä—ã—Ç–∏—è */
.toggle-btn {
  margin:8px 0;
  font-size:20px;
  cursor:pointer;
  background:none;
  border:none;
  color:#0ff;
}

table {
  width:100%;
  border-collapse:collapse;
  background-color:#5555559e;
  border-radius:0 0 10px 10px;
}
table, th, td { border:1px solid #fff; }
th, td { padding:10px; text-align:center; }
th { font-weight:bold; font-size:16px; }
td { font-size:16px; cursor:pointer; }

.total-row { font-weight:bold; background-color:#333; color:#008080; }
.sum-col { background-color:#222; color:#0ff; }

#search {
  width:80%; padding:12px; font-size:16px;
  border-radius:5px; border:none;
  margin:20px auto; display:block;
}
#search-result { margin-top:15px; }
#search-result table {
  margin-top:10px; border:2px solid #0ff; background-color:#333;
}
#search-result th { background-color:#008080; color:#000; }
#search-result td { color:#0ff; }

/* –ú–æ–¥–∞–ª–∫–∞ */
#modal {
  display:none; position:fixed; top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.7);
  justify-content:center; align-items:center;
  z-index:10000;
}
#modal.show { display:flex; }
#modal-content {
  background:#222; color:#0ff; padding:20px;
  border:2px solid #0ff; border-radius:10px;
  max-height:80%; overflow:auto;
}
#modal-close {
  background:#008080; color:#000;
  border:none; padding:5px 10px;
  cursor:pointer; font-weight:bold;
  margin-bottom:10px;
}
#modal table { width:100%; border-collapse:collapse; }
#modal th, #modal td { border:1px solid #0ff; padding:8px; text-align:center; }
#modal th { background:#008080; color:#000; }
</style>
</head>
<body>

<div class="header">
  <h1>LCDR LIVE DATA 2025</h1>
  <div class="date-info" id="date-info">DATE: --</div>
</div>

<div class="table-container">
  <input type="text" id="search" placeholder="Podaj SN (Enter)">
  <div id="search-result"></div>
</div>

<!-- FI Station Overview -->
<div class="table-container">
  <button id="overview-toggle" class="toggle-btn">üëÅ</button>
  <div id="overview-block">
    <div class="table-header">FI Station Overview</div>
    <table id="combined-table">
      <thead>
        <tr>
          <th>NAME</th><th>NDF</th><th>OK</th><th>WAITING</th>
          <th>SCRAP TTL</th><th>SCRAP PNLA</th><th>SUMA CALKOWITA</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- FI Station Diagonals -->
<div class="table-container">
  <button id="diag-toggle" class="toggle-btn">üëÅ</button>
  <div id="diag-block">
    <div class="table-header">FI Station Diagonals</div>
    <table id="diag-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div id="modal">
  <div id="modal-content">
    <button id="modal-close">–ó–∞–∫—Ä—ã—Ç—å</button>
    <div id="modal-body"></div>
  </div>
</div>

<script>
const apiKey='AIzaSyCP7tzYiGwIZ6cymLAlv_9QgPIEshnRgqI';
const sheetId='10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU';
const sheetURL=`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/`;
let combinedDataCache=[];

const diagonalMapPrefix={ 'WH8':55,'WC8':32,'WU0':43,'SQ1':43,'WM5':50,'WC7':32,'WP5':65,'WW1':75,'WM6':50 };
const diagonalMapSuffix={ '860':86,'850':85,'750':75,'700':70,'650':65,'580':58,'575':58,'550':55,'545':55,'500':50,'498':50,'495':50,'490':50,'438':43,'435':43,'430':43,'428':43,'425':43,'420':43,'418':43,'415':43,'398':43,'395':43,'390':43,'348':32,'345':32,'340':32,'328':32,'325':32,'320':32,'318':32,'315':32,'278':27,'275':27,'270':27,'248':24,'245':24,'240':24,'238':24,'235':24,'230':24};

function extractDiagonal(serial){
  if(!serial || serial.length<6) return null;
  const prefix=serial.substr(0,3); if(diagonalMapPrefix[prefix]) return diagonalMapPrefix[prefix];
  const suffix=serial.substr(3,3); if(diagonalMapSuffix[suffix]) return diagonalMapSuffix[suffix];
  return null;
}

async function getData(sheetName){
  try{
    const res=await fetch(`${sheetURL}${sheetName}?key=${apiKey}`);
    if(!res.ok) throw new Error("–û—à–∏–±–∫–∞ API");
    const data=await res.json();
    return data.values||[];
  }catch(err){ console.error(err); return []; }
}

async function fetchAndCacheData(){
  const sheet1=await getData('FI Station KOVALCHYK Y.');
  const sheet2=await getData('FI Station 2 ULANOVYCH.R');
  combinedDataCache=[...sheet1.slice(1),...sheet2.slice(1)].map(r=>({ date:r[0]||"", serial:r[2]||"", status:r[4]||"", name:r[5]||"" }));
  return combinedDataCache;
}

function getLastDate(data){
  const dates=data.map(r=>{ const d=r.date ? new Date(r.date.split(' ')[0]) : null; return d && !isNaN(d)?d:null; }).filter(d=>d!==null);
  return dates.length===0 ? new Date() : new Date(Math.max(...dates));
}

// –ú–æ–¥–∞–ª–∫–∞
const modal=document.getElementById('modal');
const modalBody=document.getElementById('modal-body');
document.getElementById('modal-close').addEventListener('click',()=>modal.classList.remove('show'));
modal.addEventListener('click',e=>{ if(e.target===modal) modal.classList.remove('show'); });

function openModal(name){
  const lastDateStr=document.getElementById('date-info').textContent.split(' ')[1];
  const records=combinedDataCache.filter(r=>r.name===name && r.date.split(' ')[0]===lastDateStr);
  if(records.length===0){ modalBody.innerHTML="<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å</p>"; }
  else{
    let html='<table><tr><th>Serial</th><th>Status</th></tr>';
    records.forEach(r=>html+=`<tr><td>${r.serial}</td><td>${r.status}</td></tr>`);
    html+='</table>'; modalBody.innerHTML=html;
  }
  modal.classList.add('show');
}

// –í–µ—Ä—Ö–Ω—è—è —Ç–∞–±–ª–∏—Ü–∞
function displayCombinedStats(filtered){
  const stats={};
  filtered.forEach(r=>{
    if(!stats[r.name]) stats[r.name]={NDF:0,OK:0,WAITING:0,'SCRAP TTL':0,'SCRAP PNLA':0,total:0};
    if(r.status==="NDF") stats[r.name].NDF++;
    if(r.status==="OK") stats[r.name].OK++;
    if(r.status==="WAITING") stats[r.name].WAITING++;
    if(r.status==="SCRAP TTL") stats[r.name]["SCRAP TTL"]++;
    if(r.status==="SCRAP PNLA") stats[r.name]["SCRAP PNLA"]++;
    stats[r.name].total++;
  });
  const tbody=document.querySelector('#combined-table tbody');
  tbody.innerHTML="";
  for(let name in stats){
    const row=document.createElement('tr');
    const tdName=document.createElement('td'); tdName.textContent=name; tdName.addEventListener('click',()=>openModal(name)); row.appendChild(tdName);
    ["NDF","OK","WAITING","SCRAP TTL","SCRAP PNLA","total"].forEach(k=>{ const td=document.createElement('td'); td.textContent=stats[name][k]; row.appendChild(td); });
    tbody.appendChild(row);
  }
}

// –ù–∏–∂–Ω—è—è —Ç–∞–±–ª–∏—Ü–∞ –¥–∏–∞–≥–æ–Ω–∞–ª–µ–π
function displayDiagonalStats(filtered){
  const diagStats={};
  filtered.forEach(({name,serial,status})=>{
    if(status!=="OK" && status!=="NDF") return;
    const diag=extractDiagonal(serial); if(!diag) return;
    if(!diagStats[name]) diagStats[name]={};
    diagStats[name][diag]=(diagStats[name][diag]||0)+1;
  });
  const tbody=document.querySelector('#diag-table tbody');
  const thead=document.querySelector('#diag-table thead');
  const allDiagonals=Array.from(new Set(Object.values(diagStats).flatMap(o=>Object.keys(o)))).sort((a,b)=>a-b);
  thead.innerHTML=`<tr><th>NAME</th>${allDiagonals.map(d=>`<th>${d}</th>`).join('')}<th class="sum-col">SUMA</th></tr>`;
  tbody.innerHTML="";
  Object.entries(diagStats).forEach(([name,diags])=>{
    const row=document.createElement('tr'); let sum=0;
    const tdName=document.createElement('td'); tdName.textContent=name; row.appendChild(tdName);
    allDiagonals.forEach(d=>{ const val=diags[d]||0; sum+=val; const td=document.createElement('td'); td.textContent=val; row.appendChild(td); });
    const tdSum=document.createElement('td'); tdSum.textContent=sum; tdSum.className="sum-col"; row.appendChild(tdSum);
    tbody.appendChild(row);
  });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
async function updateStats(){
  await fetchAndCacheData();
  const lastDate=getLastDate(combinedDataCache);
  const lastDateStr=lastDate.toISOString().split('T')[0];
  document.getElementById('date-info').textContent=`DATE: ${lastDateStr}`;
  const filtered=combinedDataCache.filter(r=>r.date.split(' ')[0]===lastDateStr);
  displayCombinedStats(filtered);
  displayDiagonalStats(filtered);
}

// –ü–æ–∏—Å–∫
async function searchSerial(serial){
  const sheet1=await getData('FI Station KOVALCHYK Y.');
  const sheet2=await getData('FI Station 2 ULANOVYCH.R');
  const combined=[...sheet1.slice(1),...sheet2.slice(1)];
  return combined.filter(r=>r[2]===serial).map(r=>({date:r[0]||"--",status:r[4]||"--",nameF:r[5]||"--",nameG:r[6]||"--",info:r[10]||"--"})).slice(0,20);
}

document.getElementById('search').addEventListener('keypress',async(e)=>{
  if(e.key==='Enter'){
    const serial=e.target.value.trim();
    const output=document.getElementById('search-result');
    if(!serial){ output.innerHTML="<p style='color:red'>Podaj SN!</p>"; return; }
    const data=await searchSerial(serial);
    if(data.length>0){
      const rows=data.map(d=>`<tr><td>${d.date}</td><td>${d.status}</td><td>${d.nameF}</td><td>${d.nameG}</td><td>${d.info}</td></tr>`).join('');
      output.innerHTML=`<table><thead><tr><th>Data</th><th>Status</th><th>NAPRAWIACZ</th><th>FINALNA</th><th>INFO</th></tr></thead><tbody>${rows}</tbody></table>`;
    } else output.innerHTML="<p style='color:yellow'>Brak info!</p>";
  }
});

// –ö–Ω–æ–ø–∫–∏ —Å–∫—Ä—ã—Ç–∏—è –±–ª–æ–∫–æ–≤
document.getElementById('overview-toggle').addEventListener('click',()=>{
  const block=document.getElementById('overview-block');
  const btn=document.getElementById('overview-toggle');
  if(block.style.display==='none'){ block.style.display='block'; btn.textContent='üëÅ'; }
  else{ block.style.display='none'; btn.textContent='üö´'; }
});
document.getElementById('diag-toggle').addEventListener('click',()=>{
  const block=document.getElementById('diag-block');
  const btn=document.getElementById('diag-toggle');
  if(block.style.display==='none'){ block.style.display='block'; btn.textContent='üëÅ'; }
  else{ block.style.display='none'; btn.textContent='üö´'; }
});

updateStats();
setInterval(updateStats,25000);
</script>
</body>
</html>
