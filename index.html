<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LCDR LIVE DATA</title>
<style>
body {
  background: url('https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-iriser-1366957.jpg') no-repeat center center fixed;
  background-size: cover;
  color:#fff;
  font-family: Arial, sans-serif;
  transition: background 1s ease-in-out;
}
body::before {
  content:"";
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  z-index:-1;
}
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px 10%;
  background-color: rgba(17,17,17,0.7);
}
.header h1 {
  margin:0;
  color:#008080;
  font-size:24px;
}
.date-info { color:#008080; font-size:24px; }
.table-container { width:80%; margin:24px auto; }
.table-header {
  background-color:#008080;
  color:#000;
  font-weight:bold;
  font-size:18px;
  padding:10px 16px;
  border-radius:10px 10px 0 0;
}
table {
  width:100%;
  border-collapse:collapse;
  background-color:#5555559e;
  border-radius:0 0 10px 10px;
}
table, th, td { border:1px solid #fff; }
th, td { padding:10px; text-align:center; }
th { font-weight:bold; font-size:16px; }
td { font-size:16px; cursor:pointer; }
#search {
  width:80%; padding:12px; font-size:16px;
  border-radius:5px; border:none;
  margin:20px auto; display:block;
}
#search-result { margin-top:15px; }
#search-result table {
  margin-top:10px; border:2px solid #0ff; background-color:#333;
}
#search-result th { background-color:#008080; color:#000; }
#search-result td { color:#0ff; }
/* Модалка */
#modal {
  display:none; position:fixed; top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.7);
  justify-content:center; align-items:center;
  z-index:10000;
}
#modal.show { display:flex; }
#modal-content {
  background:#222; color:#0ff; padding:20px;
  border:2px solid #0ff; border-radius:10px;
  max-height:80%; overflow:auto;
}
#modal-close {
  background:#008080; color:#000;
  border:none; padding:5px 10px;
  cursor:pointer; font-weight:bold;
  margin-bottom:10px;
}
#modal table { width:100%; border-collapse:collapse; }
#modal th, #modal td { border:1px solid #0ff; padding:8px; text-align:center; }
#modal th { background:#008080; color:#000; }
</style>
</head>
<body>

<div class="header">
  <h1>LCDR LIVE DATA 2025</h1>
  <div class="date-info" id="date-info">DATE: --</div>
</div>

<div class="table-container">
  <input type="text" id="search" placeholder="Podaj SN (Enter)">
  <div id="search-result"></div>
</div>

<!-- FI Station Overview -->
<div class="table-container">
  <div class="table-header">FI Station Overview</div>
  <table id="combined-table">
    <thead>
      <tr>
        <th>NAME</th><th>NDF</th><th>OK</th><th>WAITING</th>
        <th>SCRAP TTL</th><th>SCRAP PNLA</th><th>SUMA CALKOWITA</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Модалка -->
<div id="modal">
  <div id="modal-content">
    <button id="modal-close">Закрыть</button>
    <div id="modal-body"></div>
  </div>
</div>

<script>
const apiKey='AIzaSyCP7tzYiGwIZ6cymLAlv_9QgPIEshnRgqI';
const sheetId='10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU';
const sheetURL=`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/`;
let combinedDataCache=[];

async function getData(sheetName){
  try{
    const res=await fetch(`${sheetURL}${sheetName}?key=${apiKey}`);
    if(!res.ok) throw new Error("Ошибка API");
    const data=await res.json();
    return data.values||[];
  }catch(err){ console.error(err); return []; }
}

async function fetchAndCacheData(){
  const sheet1=await getData('FI Station KOVALCHYK Y.');
  const sheet2=await getData('FI Station 2 ULANOVYCH.R');
  combinedDataCache=[...sheet1.slice(1),...sheet2.slice(1)].map(r=>({
    date:r[0]||"",
    serial:r[2]||"",
    status:r[4]||"",
    name:r[5]||"",
    ocAfterRepair:r[9]||"",
    comment:r[10]||""
  }));
}

function getLastDate(data){
  const dates=data.map(r=>{ const d=r.date ? new Date(r.date.split(' ')[0]) : null; return d && !isNaN(d)?d:null; }).filter(d=>d!==null);
  return dates.length===0 ? new Date() : new Date(Math.max(...dates));
}

// Модалка
const modal=document.getElementById('modal');
const modalBody=document.getElementById('modal-body');
document.getElementById('modal-close').addEventListener('click',()=>modal.classList.remove('show'));
modal.addEventListener('click',e=>{ if(e.target===modal) modal.classList.remove('show'); });

function openModal(name){
  const lastDateStr=document.getElementById('date-info').textContent.split(' ')[1];
  const records=combinedDataCache.filter(r=>r.name===name && r.date.split(' ')[0]===lastDateStr);
  if(records.length===0){ 
    modalBody.innerHTML="<p>Нет данных за текущий день</p>"; 
  } else {
    let html='<table><tr><th>Serial</th><th>Status</th><th>OC AFTER REPAIR</th><th>COMMENT</th></tr>';
    records.forEach(r=>{
      html+=`<tr><td>${r.serial}</td><td>${r.status}</td><td>${r.ocAfterRepair}</td><td>${r.comment}</td></tr>`;
    });
    html+='</table>'; 
    modalBody.innerHTML=html;
  }
  modal.classList.add('show');
}

// Верхняя таблица
function displayCombinedStats(filtered){
  const stats={};
  filtered.forEach(r=>{
    if(!stats[r.name]) stats[r.name]={NDF:0,OK:0,WAITING:0,'SCRAP TTL':0,'SCRAP PNLA':0,total:0};
    if(r.status==="NDF") stats[r.name].NDF++;
    if(r.status==="OK") stats[r.name].OK++;
    if(r.status==="WAITING") stats[r.name].WAITING++;
    if(r.status==="SCRAP TTL") stats[r.name]["SCRAP TTL"]++;
    if(r.status==="SCRAP PNLA") stats[r.name]["SCRAP PNLA"]++;
    stats[r.name].total++;
  });
  const tbody=document.querySelector('#combined-table tbody');
  tbody.innerHTML="";
  for(let name in stats){
    const row=document.createElement('tr');
    const tdName=document.createElement('td'); tdName.textContent=name; tdName.addEventListener('click',()=>openModal(name)); row.appendChild(tdName);
    ["NDF","OK","WAITING","SCRAP TTL","SCRAP PNLA","total"].forEach(k=>{ const td=document.createElement('td'); td.textContent=stats[name][k]; row.appendChild(td); });
    tbody.appendChild(row);
  }
}

// Обновление данных
async function updateStats(){
  await fetchAndCacheData();
  const lastDate=getLastDate(combinedDataCache);
  const lastDateStr=lastDate.toISOString().split('T')[0];
  document.getElementById('date-info').textContent=`DATE: ${lastDateStr}`;
  const filtered=combinedDataCache.filter(r=>r.date.split(' ')[0]===lastDateStr);
  displayCombinedStats(filtered);
}

// Поиск
async function searchSerial(serial){
  const sheet1=await getData('FI Station KOVALCHYK Y.');
  const sheet2=await getData('FI Station 2 ULANOVYCH.R');
  const combined=[...sheet1.slice(1),...sheet2.slice(1)];
  return combined.filter(r=>r[2]===serial).map(r=>({
    date:r[0]||"--",
    status:r[4]||"--",
    nameF:r[5]||"--",
    nameG:r[6]||"--",
    info:r[10]||"--"
  })).slice(0,20);
}

document.getElementById('search').addEventListener('keypress',async(e)=>{
  if(e.key==='Enter'){
    const serial=e.target.value.trim();
    const output=document.getElementById('search-result');
    if(!serial){ output.innerHTML="<p style='color:red'>Podaj SN!</p>"; return; }
    const data=await searchSerial(serial);
    if(data.length>0){
      const rows=data.map(d=>`<tr><td>${d.date}</td><td>${d.status}</td><td>${d.nameF}</td><td>${d.nameG}</td><td>${d.info}</td></tr>`).join('');
      output.innerHTML=`<table><thead><tr><th>Data</th><th>Status</th><th>NAPRAWIACZ</th><th>FINALNA</th><th>INFO</th></tr></thead><tbody>${rows}</tbody></table>`;
    } else output.innerHTML="<p style='color:yellow'>Brak info!</p>";
  }
});

updateStats();
setInterval(updateStats,25000);

// Смена фонов
const backgrounds = [
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-carlos-oliva-1966452-3586966.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-eberhardgross-1367192.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-eberhardgross-640781.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-francesco-ungaro-1526713.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-gochrisgoxyz-1643409.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-iriser-1366957.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-joshkjack-135018.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-pixabay-326055.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-rickyrecap-2627063.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-rpnickson-2478248.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-sanaan-3075993.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-simon73-1183099.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-carlos-oliva-1966452-3586966.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-pengwhan-1767434.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-harry-shum-17627821-15984177.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-am83-12709111.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-njeromin-12766489.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-pixabay-533923.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-robshumski-1903702.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-elti-meshau-107925-333850.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-harun-tan-2311991-3980364.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-joyston-judah-331625-933054.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-francesco-ungaro-464336.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-pixabay-326055.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-pixabay-35857.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-jahoo-388415.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-therato-1933320.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-quang-nguyen-vinh-222549-2166711.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-thanhhoa-tran-640546-1462892.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-jplenio-3131634.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-quang-nguyen-vinh-222549-2563129.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-david-bartus-43782-2379653.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-dreamypixel-547114.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-sebastiaan9977-1097456.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-souvenirpixels-1519088.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-stywo-1261731.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-thatguycraig000-1563355.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/pexels-thatguycraig000-1563356.jpg",
  "https://raw.githubusercontent.com/iDLC1990/status-dashboard/main/rzeka-w-mglisty-krajobraz-gor.jpg"
];
let bgIndex = 0;
function changeBackground() {
  bgIndex = (bgIndex + 1) % backgrounds.length;
  document.body.style.background = `url('${backgrounds[bgIndex]}') no-repeat center center fixed`;
  document.body.style.backgroundSize = "cover";
}
setInterval(changeBackground, 180000);
</script>
</body>
</html>
