<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LCDR LIVE DATA</title>
<style>
body { background-color:#000; color:#fff; font-family: Arial, sans-serif; }
.header { display:flex; justify-content:space-between; align-items:center; padding:20px 10%; background-color:#112; }
.header h1 { margin:0; color:#008080; font-size:24px; }
.date-info { color:#008080; font-size:24px; }
.table-container { width:80%; margin:24px auto; }
.table-button { display:block; width:100%; padding:12px; background-color:#008080; color:#000; font-size:18px; font-weight:bold; border:none; border-radius:10px 10px 0 0; cursor:pointer; text-align:left; padding-left:20px; margin-bottom:-1px; }
table { width:100%; border-collapse:collapse; background-color:#555; border-radius:0 0 10px 10px; }
table, th, td { border:1px solid #fff; }
th, td { padding:10px; text-align:center; font-size:16px; }
th { font-weight:bold; }
.total-row { font-weight:bold; background-color:#333; color:#008080; }
</style>
</head>
<body>
<div class="header">
  <h1>LCDR LIVE DATA 2025</h1>
  <div class="date-info" id="date-info">DATE: --</div>
</div>

<div class="table-container">
  <button class="table-button">FI Station Overview</button>
  <table id="combined-table">
    <thead>
      <tr>
        <th>NAME</th>
        <th>NDF</th>
        <th>OK</th>
        <th>WAITING</th>
        <th>SCRAP TTL</th>
        <th>SCRAP PNLA</th>
        <th>SUMA CALKOWITA</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const apiKey = 'AIzaSyCP7tzYiGwIZ6cymLAlv_9QgPIEshnRgqI';
const sheetId = '10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU';
const sheetURL = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/`;

// Таблица диагоналей
const diagTableMap = { '860':86,'850':85,'750':75,'700':70,'650':65,'580':58,'575':58,'550':55,'545':55,'500':50,'498':50,'495':50,'490':50,'438':43,'435':43,'430':43,'428':43,'425':43,'420':43,'418':43,'415':43,'398':43,'395':43,'390':43,'348':32,'345':32,'340':32,'328':32,'325':32,'320':32,'318':32,'315':32,'278':27,'275':27,'270':27,'248':24,'245':24,'240':24,'238':24,'235':24,'230':24};

async function getData(sheetName) {
  const response = await fetch(`${sheetURL}${sheetName}?key=${apiKey}`);
  const data = await response.json();
  return data.values;
}

async function fetchData() {
  const sheet1Data = await getData('FI Station KOVALCHYK Y.');
  const sheet2Data = await getData('FI Station 2 ULANOVYCH.R');
  const combined = [...sheet1Data.slice(1), ...sheet2Data.slice(1)];
  return combined.map(row => ({
    name: row[5],
    status: row[4],
    serial: row[2],
    date: row[0]
  }));
}

function getLastDate(data) {
  const dates = data.map(r => r.date?.split(' ')[0] ? new Date(r.date.split(' ')[0]) : new Date(0));
  return new Date(Math.max(...dates));
}

function calculateStats(data) {
  const stats = {};
  data.forEach(({name, status})=>{
    if(!stats[name]) stats[name]={NDF:0,OK:0,WAITING:0,'SCRAP TTL':0,'SCRAP PNLA':0,total:0};
    if(status==='NDF') stats[name].NDF++;
    if(status==='OK') stats[name].OK++;
    if(status==='WAITING') stats[name].WAITING++;
    if(status==='SCRAP TTL') stats[name]['SCRAP TTL']++;
    if(status==='SCRAP PNLA') stats[name]['SCRAP PNLA']++;
    stats[name].total++;
  });
  return stats;
}

function displayCombinedStats(stats) {
  const tbody = document.querySelector('#combined-table tbody');
  tbody.innerHTML='';
  const totals={NDF:0,OK:0,WAITING:0,'SCRAP TTL':0,'SCRAP PNLA':0,total:0};
  Object.entries(stats).sort(([,a],[,b])=>b.OK-a.OK).forEach(([name,data])=>{
    const row=document.createElement('tr');
    row.innerHTML=`<td>${name}</td><td>${data.NDF}</td><td>${data.OK}</td><td>${data.WAITING}</td><td>${data['SCRAP TTL']}</td><td>${data['SCRAP PNLA']}</td><td>${data.total}</td>`;
    tbody.appendChild(row);
    for(let k in totals) totals[k]+=data[k];
  });
  const totalRow=document.createElement('tr');
  totalRow.className='total-row';
  totalRow.innerHTML=`<td>SUMA</td><td>${totals.NDF}</td><td>${totals.OK}</td><td>${totals.WAITING}</td><td>${totals['SCRAP TTL']}</td><td>${totals['SCRAP PNLA']}</td><td>${totals.total}</td>`;
  tbody.appendChild(totalRow);
}

// --- Диагонали ---
let diagTableContainer=null,diagTable=null,diagTbody=null;

function initDiagonalTable(allDiagonals){
  if(!diagTableContainer){
    diagTableContainer=document.createElement('div');
    diagTableContainer.className='table-container';
    const title=document.createElement('button');
    title.className='table-button';
    title.textContent='Diagonal Stats (OK + NDF)';
    diagTableContainer.appendChild(title);

    diagTable=document.createElement('table');
    const thead=document.createElement('thead');
    const headRow=document.createElement('tr');
    headRow.innerHTML=`<th>NAME</th>`+allDiagonals.map(d=>`<th>${d}</th>`).join('');
    thead.appendChild(headRow);
    diagTable.appendChild(thead);

    diagTbody=document.createElement('tbody');
    diagTable.appendChild(diagTbody);

    diagTableContainer.appendChild(diagTable);
    document.body.appendChild(diagTableContainer);
  } else {
    const thead=diagTable.querySelector('thead');
    thead.innerHTML='';
    const headRow=document.createElement('tr');
    headRow.innerHTML=`<th>NAME</th>`+allDiagonals.map(d=>`<th>${d}</th>`).join('');
    thead.appendChild(headRow);
  }
}

function displayDiagonalStats(data){
  const diagStats={};
  data.forEach(({name,status,serial})=>{
    if(!diagStats[name]) diagStats[name]={};
    if(!serial) return;
    const diagKey=serial.substr(3,3); // 3 первые буквы пропускаем
    const diag=diagTableMap[diagKey];
    if(!diag) return;
    if(status==='OK'||status==='NDF'){
      diagStats[name][diag]=(diagStats[name][diag]||0)+1;
    }
  });
  const allDiagonals=Array.from(new Set(Object.values(diagStats).flatMap(obj=>Object.keys(obj)))).sort((a,b)=>Number(a)-Number(b));
  initDiagonalTable(allDiagonals);
  diagTbody.innerHTML='';
  Object.entries(diagStats).forEach(([name,diags])=>{
    const row=document.createElement('tr');
    row.innerHTML=`<td>${name}</td>`+allDiagonals.map(d=>`<td>${diags[d]||0}</td>`).join('');
    diagTbody.appendChild(row);
  });
}

// --- Обновление ---
async function updateStats(){
  const combinedData=await fetchData();
  const lastDate=getLastDate(combinedData);
  const lastDateStr=lastDate.toISOString().split('T')[0];
  const filtered=combinedData.filter(r=>r.date?.split(' ')[0]===lastDateStr);
  const stats=calculateStats(filtered);
  displayCombinedStats(stats);
  displayDiagonalStats(filtered);
  document.getElementById('date-info').textContent=`DATE: ${lastDateStr}`;
}

setInterval(updateStats,25000);
updateStats();

</script>
</body>
</html>