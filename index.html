<script>
  async function showTooltip(e, name) {
    const combinedData = await fetchData();
    const lastDateStr = document.getElementById('date-info').textContent.split(' ')[1];

    // Фильтруем записи по имени и текущей дате
    const records = combinedData.filter(r => r.name === name && r.date?.split(' ')[0] === lastDateStr);

    if (records.length === 0) return;

    // Создаём таблицу для tooltip
    let html = '<table style="border:1px solid #0ff; background:#222;"><tr><th>Serial</th><th>Status</th></tr>';
    records.forEach(r => {
      html += `<tr><td>${r.serial}</td><td>${r.status}</td></tr>`;
    });
    html += '</table>';

    let tooltip = document.createElement('div');
    tooltip.id = 'tooltip-table';
    tooltip.style.position = 'absolute';
    tooltip.style.background = '#333';
    tooltip.style.border = '1px solid #0ff';
    tooltip.style.padding = '10px';
    tooltip.style.zIndex = '1000';
    tooltip.innerHTML = html;
    document.body.appendChild(tooltip);

    function moveTooltip(event) {
      tooltip.style.top = (event.pageY + 15) + 'px';
      tooltip.style.left = (event.pageX + 15) + 'px';
    }

    moveTooltip(e);
    e.target.addEventListener('mousemove', moveTooltip);

    e.target.addEventListener('mouseout', () => {
      tooltip.remove();
    }, { once: true });
  }

  // Изменяем функцию displayCombinedStats для добавления tooltip
  function displayCombinedStats(stats) {
    const tbody = document.querySelector('#combined-table tbody');
    tbody.innerHTML = '';

    const totals = { NDF: 0, OK: 0, WAITING: 0, 'SCRAP TTL': 0, 'SCRAP PNLA': 0, total: 0 };
    const sortedStats = Object.entries(stats).sort(([, a], [, b]) => b.OK - a.OK);

    sortedStats.forEach(([name, data]) => {
      const row = document.createElement('tr');

      // Фамилия с tooltip
      const nameTd = document.createElement('td');
      nameTd.textContent = name;
      nameTd.style.cursor = 'pointer';
      nameTd.addEventListener('mouseover', e => showTooltip(e, name));

      row.appendChild(nameTd);
      row.innerHTML += `<td>${data.NDF}</td><td>${data.OK}</td><td>${data.WAITING}</td><td>${data['SCRAP TTL']}</td><td>${data['SCRAP PNLA']}</td><td>${data.total}</td>`;

      tbody.appendChild(row);

      totals.NDF += data.NDF;
      totals.OK += data.OK;
      totals.WAITING += data.WAITING;
      totals['SCRAP TTL'] += data['SCRAP TTL'];
      totals['SCRAP PNLA'] += data['SCRAP PNLA'];
      totals.total += data.total;
    });

    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML = `<td>SUMA</td><td>${totals.NDF}</td><td>${totals.OK}</td><td>${totals.WAITING}</td><td>${totals['SCRAP TTL']}</td><td>${totals['SCRAP PNLA']}</td><td>${totals.total}</td>`;
    tbody.appendChild(totalRow);
  }
</script>
